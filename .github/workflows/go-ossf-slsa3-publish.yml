name: Automated Go AAR Build and Release

on:
  # è§¦å‘æ¡ä»¶ï¼š
  # 1. å½“æ¨é€æ–°çš„ Git Tag æ—¶ï¼ˆä¾‹å¦‚ï¼šv1.0.0ï¼‰ï¼Œç”¨äºæ­£å¼å‘å¸ƒã€‚
  push:
    tags:
      - 'v*.*.*' 
  # 2. å…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œç”¨äºæµ‹è¯•ã€‚
  workflow_dispatch:

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    
    # æˆäºˆå†™å…¥æƒé™ï¼Œç”¨äºåˆ›å»º Release å¹¶ä¸Šä¼ é™„ä»¶
    permissions:
      contents: write 

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # 1. å®šä¹‰æ ¸å¿ƒé…ç½®å˜é‡
      # ----------------------------------------------------
      - name: Define AAR Configuration Variables
        id: config
        run: |
          # AAR åº“åå’ŒåŒ…åã€‚è¿™æ˜¯ Android å¯¼å…¥æ—¶ä½¿ç”¨çš„åŒ…åã€‚
          echo "AAR_LIB_NAME=gomobileproxy" >> $GITHUB_OUTPUT
          # æœ€ç»ˆç”Ÿæˆçš„ AAR æ–‡ä»¶å
          echo "AAR_FILE_NAME=${{ steps.config.outputs.AAR_LIB_NAME }}.aar" >> $GITHUB_OUTPUT

      # ----------------------------------------------------
      # 2. è‡ªåŠ¨å¤„ç† Go æºç  (å˜é‡/åŒ…åå¤„ç†)
      # ----------------------------------------------------
      - name: Automated Go Source Refactoring (Package and Entry Point)
        run: |
          AAR_LIB_NAME=${{ steps.config.outputs.AAR_LIB_NAME }}
          GO_FILE_NAME="a.go"
          
          echo "--- æ­£åœ¨å°† ${GO_FILE_NAME} ä» package main è½¬æ¢ä¸º package ${AAR_LIB_NAME} ---"
          
          # 1. æ›¿æ¢ package main ä¸ºåº“åŒ…å (å¤„ç†åŒ…åå˜é‡)
          sed -i "1s/package main/package ${AAR_LIB_NAME}/" ${GO_FILE_NAME}
          
          # 2. å°† func main() é‡å‘½åä¸º func runMain() (å¤„ç†ä¸»å‡½æ•°åå˜é‡)
          sed -i 's/func main()/func runMain()/' ${GO_FILE_NAME}
          
          # 3. è‡ªåŠ¨æ·»åŠ  Go åº“æ‰€éœ€çš„ go.mod æ–‡ä»¶ï¼Œå¹¶ä¸‹è½½ä¾èµ–
          go mod init ${AAR_LIB_NAME}
          go mod tidy
          
          # 4. åœ¨æ–‡ä»¶æœ«å°¾è¿½åŠ  Android è°ƒç”¨çš„**å¯¼å‡ºçš„**å…¥å£å‡½æ•°ï¼šStart()
          echo "" >> ${GO_FILE_NAME}
          echo "// Start is the mandatory entry point for Android, exposed by gomobile bind." >> ${GO_FILE_NAME}
          echo "// It runs the original main logic in a new goroutine to avoid blocking the UI thread." >> ${GO_FILE_NAME}
          echo "func Start() {" >> ${GO_FILE_NAME}
          echo "    go runMain()" >> ${GO_FILE_NAME}
          echo "}" >> ${GO_FILE_NAME}
          
          echo "--- ç¡®è®¤ä¿®æ”¹åçš„ ${GO_FILE_NAME} å¤´éƒ¨å’Œå°¾éƒ¨ç‰‡æ®µ ---"
          head -n 5 ${GO_FILE_NAME}
          tail -n 10 ${GO_FILE_NAME}

      # ----------------------------------------------------
      # 3. ç¯å¢ƒè®¾ç½®å’Œç¼–è¯‘
      # ----------------------------------------------------
      - name: Set up Go and NDK
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          
      - name: Set up Android NDK (Required for gomobile)
        uses: android-actions/setup-android@v3
        with:
          ndk: '25.2.9519653' 

      - name: Install gomobile tools and init
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          gomobile init
          
      - name: Compile to Android AAR (ARM/ARM64)
        run: |
          # ç¼–è¯‘ Go åº“ä¸º Android AARï¼Œæ”¯æŒ ARM 32ä½å’Œ 64ä½
          gomobile bind \
            -target=android/arm,android/arm64 \
            -v \
            -o ${{ steps.config.outputs.AAR_FILE_NAME }} \
            ./ 
            
      # ----------------------------------------------------
      # 4. åˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶
      # ----------------------------------------------------
      - name: Create Release and Upload AAR
        uses: softprops/action-gh-release@v1
        # ä»…åœ¨æ¨é€ tag æ—¶æ‰åˆ›å»º Release
        if: startsWith(github.ref, 'refs/tags/') 
        with:
          files: ${{ steps.config.outputs.AAR_FILE_NAME }} 
          name: Release ${{ github.ref_name }}
          body: |
            ğŸ‰ **Go AAR è‡ªåŠ¨åŒ–æ„å»ºæˆåŠŸ**

            **åº“å:** ${{ steps.config.outputs.AAR_LIB_NAME }}
            **æ–‡ä»¶å:** ${{ steps.config.outputs.AAR_FILE_NAME }}

            **é›†æˆè¯´æ˜ï¼š**
            1.  å°† AAR æ–‡ä»¶å¯¼å…¥ Android é¡¹ç›®ã€‚
            2.  åœ¨ Java/Kotlin ä¸­é€šè¿‡ `import ${{ steps.config.outputs.AAR_LIB_NAME }}` å¯¼å…¥ã€‚
            3.  è°ƒç”¨ `{{ steps.config.outputs.AAR_LIB_NAME }}.Start()` æ¥è¿è¡Œæ‚¨åŸå…ˆ `a.go` ä¸­çš„é€»è¾‘ã€‚
            
            âš ï¸ **æ³¨æ„ï¼š** åŸä»£ç ä¸­çš„ `listenAddr` ç­‰å…¨å±€å˜é‡æ˜¯å†…éƒ¨çš„ï¼Œæ— æ³•ç›´æ¥é€šè¿‡ Android è°ƒç”¨è¿›è¡Œé…ç½®ã€‚
          draft: false
          prerelease: false
