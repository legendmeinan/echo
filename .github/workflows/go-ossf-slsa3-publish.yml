name: Automated Go AAR Build and Release

on:
  # è§¦å‘æ¡ä»¶ï¼š
  # 1. å½“æ¨é€æ–°çš„ Git Tag æ—¶ï¼ˆä¾‹å¦‚ï¼šv1.0.0ï¼‰ï¼Œç”¨äºæ­£å¼å‘å¸ƒã€‚
  push:
    tags:
      - 'v*.*.*' 
  # 2. å…è®¸æ‰‹åŠ¨è§¦å‘ï¼Œç”¨äºæµ‹è¯•ã€‚
  workflow_dispatch:

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    
    # æˆäºˆå†™å…¥æƒé™ï¼Œç”¨äºåˆ›å»º Release å¹¶ä¸Šä¼ é™„ä»¶
    permissions:
      contents: write 

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # 1. å®šä¹‰æ ¸å¿ƒé…ç½®å˜é‡
      # ----------------------------------------------------
      - name: Define AAR Configuration Variables
        id: config
        run: |
          # AAR åº“åå’ŒåŒ…åã€‚è¿™æ˜¯ Android å¯¼å…¥æ—¶ä½¿ç”¨çš„åŒ…åã€‚
          echo "AAR_LIB_NAME=gomobileproxy" >> $GITHUB_OUTPUT
          # æœ€ç»ˆç”Ÿæˆçš„ AAR æ–‡ä»¶å
          echo "AAR_FILE_NAME=${{ steps.config.outputs.AAR_LIB_NAME }}.aar" >> $GITHUB_OUTPUT
          # ä¿®å¤ç‚¹ï¼šæŒ‡å®šæœ€ä½ API çº§åˆ«ä¸º 21ï¼Œè§£å†³ API 16 ä¸æ”¯æŒçš„é—®é¢˜
          echo "ANDROID_API_LEVEL=21" >> $GITHUB_OUTPUT

      # ----------------------------------------------------
      # 2. è‡ªåŠ¨å¤„ç† Go æºç  (åŒ…åå’Œå…¥å£å‡½æ•°å¤„ç†)
      # ----------------------------------------------------
      - name: Automated Go Source Refactoring (Package and Entry Point)
        run: |
          AAR_LIB_NAME=${{ steps.config.outputs.AAR_LIB_NAME }}
          GO_FILE_NAME="a.go"
          
          echo "--- æ­£åœ¨å°† ${GO_FILE_NAME} ä» package main è½¬æ¢ä¸º package ${AAR_LIB_NAME} ---"
          
          # 1. æ›¿æ¢ package main ä¸ºåº“åŒ…å
          sed -i "1s/package main/package ${AAR_LIB_NAME}/" ${GO_FILE_NAME}
          
          # 2. å°† func main() é‡å‘½åä¸º func runMain()
          sed -i 's/func main()/func runMain()/' ${GO_FILE_NAME}
          
          # 3. è‡ªåŠ¨æ·»åŠ  Go åº“æ‰€éœ€çš„ go.mod æ–‡ä»¶ï¼Œå¹¶ä¸‹è½½ä¾èµ–
          go mod init ${AAR_LIB_NAME}
          go mod tidy
          
          # 4. æ·»åŠ å¯¼å‡ºçš„å…¥å£å‡½æ•°ï¼šStart()
          echo "" >> ${GO_FILE_NAME}
          echo "// Start is the mandatory entry point for Android, exposed by gomobile bind." >> ${GO_FILE_NAME}
          echo "// It runs the original main logic in a new goroutine to avoid blocking the UI thread." >> ${GO_FILE_NAME}
          echo "func Start() {" >> ${GO_FILE_NAME}
          echo "    go runMain()" >> ${GO_FILE_NAME}
          echo "}" >> ${GO_FILE_NAME}


      # ----------------------------------------------------
      # 3. ç¯å¢ƒè®¾ç½®å’Œä¾èµ–å®‰è£…
      # ----------------------------------------------------
      - name: Set up Go and NDK
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          
      - name: Set up Android NDK (Required for gomobile)
        uses: android-actions/setup-android@v3
        with:
          ndk: '25.2.9519653' # ç¨³å®šçš„ NDK ç‰ˆæœ¬

      - name: Install gomobile tools and initialize
        run: |
          # 1. å®‰è£… gomobile å¯æ‰§è¡Œæ–‡ä»¶
          go install golang.org/x/mobile/cmd/gomobile@latest
          
          # 2. å…³é”®ä¿®å¤ï¼šæ˜¾å¼è·å– gomobile ä¾èµ–çš„ core æ¨¡å—
          # ç¡®ä¿ gobind èƒ½æ‰¾åˆ° golang.org/x/mobile/bind åŒ…ï¼Œè§£å†³ "no Go package" é”™è¯¯
          go mod download golang.org/x/mobile
          
          # 3. åˆå§‹åŒ– gomobile ç¯å¢ƒï¼Œä¸‹è½½å¿…è¦çš„ Android NDK/SDK ç»„ä»¶
          gomobile init
          
      # ----------------------------------------------------
      # 4. ç¼–è¯‘ AAR
      # ----------------------------------------------------
      - name: Compile to Android AAR (ARM/ARM64)
        run: |
          gomobile bind \
            -target=android/arm,android/arm64 \
            -androidapi ${{ steps.config.outputs.ANDROID_API_LEVEL }} \
            -v \
            -o ${{ steps.config.outputs.AAR_FILE_NAME }} \
            ./ 
            
      # ----------------------------------------------------
      # 5. åˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶
      # ----------------------------------------------------
      - name: Create Release and Upload AAR
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/') 
        with:
          files: ${{ steps.config.outputs.AAR_FILE_NAME }} 
          name: Release ${{ github.ref_name }}
          body: |
            ğŸ‰ **Go AAR è‡ªåŠ¨åŒ–æ„å»ºæˆåŠŸ**

            **åº“å:** ${{ steps.config.outputs.AAR_LIB_NAME }}
            **æ–‡ä»¶å:** ${{ steps.config.outputs.AAR_FILE_NAME }}
            **ç›®æ ‡ API çº§åˆ«:** ${{ steps.config.outputs.ANDROID_API_LEVEL }} (Android 5.0+)
          draft: false
          prerelease: false
