name: Automated Go AAR Build and Release

on:
  push:
    tags:
      - 'v*.*.*' 
  workflow_dispatch:

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write 

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # 1. å®šä¹‰æ ¸å¿ƒé…ç½®å˜é‡
      # ----------------------------------------------------
      - name: Define AAR Configuration Variables
        id: config
        run: |
          echo "AAR_LIB_NAME=gomobileproxy" >> $GITHUB_OUTPUT
          echo "AAR_FILE_NAME=${{ steps.config.outputs.AAR_LIB_NAME }}.aar" >> $GITHUB_OUTPUT
          echo "ANDROID_API_LEVEL=21" >> $GITHUB_OUTPUT

      # ----------------------------------------------------
      # 2. è‡ªåŠ¨å¤„ç† Go æºç  (åŒ…åå’Œå…¥å£å‡½æ•°å¤„ç†)
      # ----------------------------------------------------
      - name: Automated Go Source Refactoring (Package and Entry Point)
        run: |
          AAR_LIB_NAME=${{ steps.config.outputs.AAR_LIB_NAME }}
          GO_FILE_NAME="a.go"
          
          # 1. æ›¿æ¢ package main ä¸ºåº“åŒ…å
          sed -i "1s/package main/package ${AAR_LIB_NAME}/" ${GO_FILE_NAME}
          
          # 2. å°† func main() é‡å‘½åä¸º func runMain()
          sed -i 's/func main()/func runMain()/' ${GO_FILE_NAME}
          
          # 3. è‡ªåŠ¨æ·»åŠ  Go åº“æ‰€éœ€çš„ go.mod æ–‡ä»¶
          go mod init ${AAR_LIB_NAME}
          
          # 4. æ·»åŠ å¯¼å‡ºçš„å…¥å£å‡½æ•°ï¼šStart()
          echo "" >> ${GO_FILE_NAME}
          echo "// Start is the mandatory entry point for Android, exposed by gomobile bind." >> ${GO_FILE_NAME}
          echo "// It runs the original main logic in a new goroutine to avoid blocking the UI thread." >> ${GO_FILE_NAME}
          echo "func Start() {" >> ${GO_FILE_NAME}
          echo "    go runMain()" >> ${GO_FILE_NAME}
          echo "}" >> ${GO_FILE_NAME}
          
          # 5. è¿è¡Œ go mod tidy æ¥ä¸‹è½½ a.go å†…éƒ¨çš„ä¾èµ–
          go mod tidy

      # ----------------------------------------------------
      # 3. ç¯å¢ƒè®¾ç½®å’Œä¾èµ–å®‰è£… (å·²ä¿®æ­£ Go ç‰ˆæœ¬å’Œä¾èµ–é—®é¢˜)
      # ----------------------------------------------------
      - name: Set up Go and NDK
        uses: actions/setup-go@v5
        with:
          # ä¿®å¤ç‚¹ï¼šç›´æ¥ä½¿ç”¨ Go 1.24
          go-version: '1.24'
          
      - name: Set up Android NDK (Required for gomobile)
        uses: android-actions/setup-android@v3
        with:
          ndk: '25.2.9519653' 

      # ----------------------------------------------------
      # 4. å®‰è£… gomobile å·¥å…·å’Œåˆå§‹åŒ– (å…³é”®ä¿®å¤ç‚¹ï¼šè®¾ç½® PATH)
      # ----------------------------------------------------
      - name: Install gomobile tools and initialize
        run: |
          # ä¿®å¤ç‚¹ï¼šå°† Go çš„äºŒè¿›åˆ¶ç›®å½•æ·»åŠ åˆ° PATHï¼Œç¡®ä¿ gomobile å‘½ä»¤å¯è¢«æ‰¾åˆ°
          export PATH=$PATH:$(go env GOPATH)/bin
          
          # å®‰è£… gomobile
          go get golang.org/x/mobile/cmd/gomobile@latest
          
          # åˆå§‹åŒ– gomobile ç¯å¢ƒ
          gomobile init
          
      # ----------------------------------------------------
      # 5. ç¼–è¯‘ AAR
      # ----------------------------------------------------
      - name: Compile to Android AAR (ARM/ARM64)
        run: |
          # ä¿®å¤ç‚¹ï¼šç¡®ä¿ PATH ä»ç„¶åŒ…å« gomobile
          export PATH=$PATH:$(go env GOPATH)/bin
          
          # ç¼–è¯‘å‘½ä»¤
          gomobile bind \
            -target=android/arm,android/arm64 \
            -androidapi ${{ steps.config.outputs.ANDROID_API_LEVEL }} \
            -v \
            -o ${{ steps.config.outputs.AAR_FILE_NAME }} \
            ./ 
            
      # ----------------------------------------------------
      # 6. åˆ›å»º Release å¹¶ä¸Šä¼ æ–‡ä»¶
      # ----------------------------------------------------
      - name: Create Release and Upload AAR
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/') 
        with:
          files: ${{ steps.config.outputs.AAR_FILE_NAME }} 
          name: Release ${{ github.ref_name }}
          body: |
            ğŸ‰ **Go AAR è‡ªåŠ¨åŒ–æ„å»ºæˆåŠŸ**

            **åº“å:** ${{ steps.config.outputs.AAR_LIB_NAME }}
            **æ–‡ä»¶å:** ${{ steps.config.outputs.AAR_FILE_NAME }}
            **ç›®æ ‡ API çº§åˆ«:** ${{ steps.config.outputs.ANDROID_API_LEVEL }} (Android 5.0+)
          draft: false
          prerelease: false
